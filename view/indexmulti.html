<!DOCTYPE html>
<html lang="en">
  <head>
    <title>WhatsappBot Ekatunggal</title>
    <style>
      .client {
        border: solid 1px #ccc;
        padding: 2px;
        box-sizing: border-box;
        display: inline-block;
        margin: 10px;
      }
      .hide {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h1>Whatsapp API</h1>
      <p>Powered by IT Ekatungggal</p>
      <div class="form-container">
        <label for="client-id">ID</label><br />
        <input type="text" id="client-id" placeholder="Masukan ID" />
        <br /><br />
        <labelfor="cliend-description"
          >Deskripsi</label
        ><br />
        <textarea
          rows="3"
          type="text"
          id="client-description"
          placeholder="Masukan Deskripsi"
        ></textarea>
        <br /><br />
        <button class="add-client-btn">Tambah Client</button>
      </div>
      <hr />
      <div class="client-container">
        <div class="client hide">
          <h3 class="title"></h3>
          <p class="description"></p>
          <img src="" alt="QRCODE" id="qrcode" />
          <h3>Logs :</h3>
          <ul class="logs"></ul>
        </div>
      </div>
    </div>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
      integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"
      integrity="sha512-iqRVtNB+t9O+epcgUTIPF+nklypcR23H1yR1NFM9kffn6/iBhZ9bTB6oKLaGMv8JE9UgjcwfBFg/eHC/VMws+g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      $(document).ready(function () {
        var socket = io();
        // Ketika button tambah di klik
        $(".add-client-btn").click(function () {
          var clientID = $("#client-id").val();
          var clientDescription = $("#client-description").val();
          var template = $(".client")
            .first()
            .clone()
            .removeClass("hide")
            .addClass(clientID);
          template.find(".title").html(clientID);
          template.find(".description").html(clientDescription);
          $(".client-container").append(template);

          socket.emit("create-session",{
          id:clientID,
          description:clientDescription,
        })
        });     


        socket.on('init',(data)=>{
          for(var i=0;i<data.length;i++){
            var session = data[i]
            var clientID = session.id
            var clientDescription = session.description;
            var template = $(".client")
              .first()
              .clone()
              .removeClass("hide")
              .addClass(clientID);
            template.find(".title").html(clientID);
            template.find(".description").html(clientDescription);
            $(".client-container").append(template);

            if(session.ready){
              $(`.client.${session.id} .logs`).append($("<li>").text("Whatsapp is ready .."));
            }else{
              $(`.client.${session.id} .logs`).append($("<li>").text("Connecting ..."));
            }
          }
        })

        socket.on("message", (data) => {
          $(`.client.${data.id} .logs`).append($("<li>").text(data.text));
        });

        socket.on("qr", (data) => {
          $(`.client.${data.id} #qrcode`).attr("src", data.src);
          $(`.client.${data.id} #qrcode`).show()
        });

        socket.on("ready", (data) => {
          $(`.client.${data.id} #qrcode`).hide();
        });

        socket.on("authenticated", (data) => {
          $(`.client.${data.id} #qrcode`).hide();
        });
      });
    </script>
  </body>
</html>
